steps:
    - id: "Build Docker Image"
      name: "gcr.io/cloud-builders/docker"
      args:
          - "build"
          - "-t"
          - "$_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:$COMMIT_SHA"
          - "."

    - id: "Publish Image to Artifact Registry"
      name: "gcr.io/cloud-builders/docker"
      args:
          - "push"
          - "$_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:$COMMIT_SHA"

    - id: "Deploy Image to Cloud Run"
      name: "gcr.io/cloud-builders/gcloud"
      args:
          - "run"
          - "deploy"
          - "$_SERVICE_NAME"
          - "--image"
          - "$_GCR_HOSTNAME/$PROJECT_ID/$_SERVICE_NAME:$COMMIT_SHA"
          - "--region"
          - "$_DEPLOY_REGION"
          - "--port"
          - "8080"
          - "--allow-unauthenticated"

options:
    machineType: "E2_MEDIUM"
    logging: "CLOUD_LOGGING_ONLY"

timeout: "1200s"
